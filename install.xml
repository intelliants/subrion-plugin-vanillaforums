<?xml version="1.0" encoding="utf-8"?>
<plugin name="vanillaforums">
	<title>Vanilla Single Sign-On</title>
	<summary>Vanilla forums members integration plugin.</summary>
	<author>Intelliants LLC</author>
	<contributor>Intelliants LLC</contributor>
	<version>4.0.1</version>
	<date>2016-01-06</date>
	<compatibility>4.0</compatibility>

	<config group="miscellaneous" name="vanilla_separator" type="divider">Vanilla forums</config>
	<config group="miscellaneous" name="vanilla_client_id" type="text" description="Vanilla client ID"><![CDATA[]]></config>
	<config group="miscellaneous" name="vanilla_secret_key" type="text" description="Vanilla secret"><![CDATA[]]></config>

	<hooks>
		<hook name="phpCoreBeforePageDisplay" page_type="front" pages="login">
			<![CDATA[
if (iaView::REQUEST_JSON == $iaView->getRequestType())
{
	$clientId = $iaCore->get('vanilla_client_id');
	$secret = $iaCore->get('vanilla_secret_key');

	// init users class
	$iaUsers = $iaCore->factory('users');

	$vanillaUser = array();
	if (!empty($clientId) && !empty($secret))
	{
		// include jsConnect library
		require_once IA_PLUGINS . 'vanillaforums' . IA_DS . 'includes' . IA_DS . 'functions.jsconnect.php';

		if (iaUsers::hasIdentity())
		{
			// fill in the user information in a way that Vanilla can understand
			$vanillaUser['uniqueid'] = iaUsers::getIdentity()->id;
			$vanillaUser['name'] = iaUsers::getIdentity()->username;
			$vanillaUser['email'] = iaUsers::getIdentity()->email;

			if (iaUsers::getIdentity()->avatar)
			{
				$avatar = unserialize(iaUsers::getIdentity()->avatar);
				$vanillaUser['photourl'] = IA_CLEAR_URL . 'uploads/' . $avatar['path'];
			}
		}
		elseif (!iaUsers::hasIdentity())
		{
			$this->factory('util');
			iaUtil::go_to(IA_URL . 'login/');
		}

		// generate the jsConnect string
		WriteJsConnect($vanillaUser, $_GET, $clientId, $secret, false);
		exit;
	}
}
			]]>
		</hook>
	</hooks>
</plugin>